<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>channel | 个人站点</title>
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/goistio.book/assets/css/0.styles.1c9099ac.css" as="style"><link rel="preload" href="/goistio.book/assets/js/app.c80f4f4d.js" as="script"><link rel="preload" href="/goistio.book/assets/js/2.00693aab.js" as="script"><link rel="preload" href="/goistio.book/assets/js/10.d65de9ee.js" as="script"><link rel="prefetch" href="/goistio.book/assets/js/11.cd390daf.js"><link rel="prefetch" href="/goistio.book/assets/js/12.d37dfcd2.js"><link rel="prefetch" href="/goistio.book/assets/js/13.e0915440.js"><link rel="prefetch" href="/goistio.book/assets/js/14.d2d496fc.js"><link rel="prefetch" href="/goistio.book/assets/js/15.3da8ec74.js"><link rel="prefetch" href="/goistio.book/assets/js/16.6e583aed.js"><link rel="prefetch" href="/goistio.book/assets/js/17.6b02654b.js"><link rel="prefetch" href="/goistio.book/assets/js/18.dd74adb6.js"><link rel="prefetch" href="/goistio.book/assets/js/19.dfd4feed.js"><link rel="prefetch" href="/goistio.book/assets/js/3.9236af90.js"><link rel="prefetch" href="/goistio.book/assets/js/4.0f091beb.js"><link rel="prefetch" href="/goistio.book/assets/js/5.b7f21dd7.js"><link rel="prefetch" href="/goistio.book/assets/js/6.02510c18.js"><link rel="prefetch" href="/goistio.book/assets/js/7.7857b5b1.js"><link rel="prefetch" href="/goistio.book/assets/js/8.be2063e7.js"><link rel="prefetch" href="/goistio.book/assets/js/9.c66fdafb.js">
    <link rel="stylesheet" href="/goistio.book/assets/css/0.styles.1c9099ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/goistio.book/" class="home-link router-link-active"><!----> <span class="site-name">个人站点</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/goistio.book/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/goistio.book/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/goistio.book/" class="sidebar-link">go学习笔记</a></li><li><a href="/goistio.book/ip转int.html" class="sidebar-link">ip转int</a></li><li><a href="/goistio.book/排序算法.html" class="sidebar-link">排序算法</a></li><li><a href="/goistio.book/环境搭建.html" class="sidebar-link">环境搭建</a></li><li><a href="/goistio.book/设计模式.html" class="sidebar-link">设计模式</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Istio</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/goistio.book/istio/interface.html" class="sidebar-link">空接口</a></li><li><a href="/goistio.book/istio/代码二三事.html" class="sidebar-link">避坑指南</a></li><li><a href="/goistio.book/istio/内存分配2.html" class="sidebar-link">内存分配2</a></li><li><a href="/goistio.book/istio/内存模型.html" class="active sidebar-link">channel</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/goistio.book/istio/内存模型.html#channel" class="sidebar-link">channel</a></li><li class="sidebar-sub-header"><a href="/goistio.book/istio/内存模型.html#锁" class="sidebar-link">锁</a></li><li class="sidebar-sub-header"><a href="/goistio.book/istio/内存模型.html#内存分配" class="sidebar-link">内存分配</a></li><li class="sidebar-sub-header"><a href="/goistio.book/istio/内存模型.html#bitmap" class="sidebar-link">bitmap</a></li></ul></li><li><a href="/goistio.book/istio/学习笔记.html" class="sidebar-link">istio</a></li><li><a href="/goistio.book/istio/最小镜像.html" class="sidebar-link">创建最小go镜像</a></li><li><a href="/goistio.book/istio/环境搭建.html" class="sidebar-link">k8s</a></li><li><a href="/goistio.book/istio/简介.html" class="sidebar-link">istio简介</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Package</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="channel"><a href="#channel" class="header-anchor">#</a> channel</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/chan.go</span>
<span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	qcount   <span class="token builtin">uint</span>           <span class="token comment">// total data in the queue</span>
	dataqsiz <span class="token builtin">uint</span>           <span class="token comment">// size of the circular queue</span>
	buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// points to an array of dataqsiz elements</span>
	elemsize <span class="token builtin">uint16</span>
	closed   <span class="token builtin">uint32</span>
	elemtype <span class="token operator">*</span>_type <span class="token comment">// element type</span>
	sendx    <span class="token builtin">uint</span>   <span class="token comment">// send index</span>
	recvx    <span class="token builtin">uint</span>   <span class="token comment">// receive index</span>
	recvq    waitq  <span class="token comment">// list of recv waiters</span>
	sendq    waitq  <span class="token comment">// list of send waiters</span>
	lock mutex <span class="token comment">// 发送接收数据都会加锁</span>
<span class="token punctuation">}</span>
<span class="token comment">// 每一步操作都加锁,把数据从goroutine复制到循环链表,或数据从循环链表复制到goroutine</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaepw14mw9j31h80u0kjl.jpg" alt="image-20191230140722855"></p> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <p>cas或轮询</p> <p>公平锁、非公平锁:在锁获取过程中是否先进行锁获取的线程更先获得锁</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">int32</span> <span class="token comment">// 锁计数</span>
	sema  <span class="token builtin">uint32</span> <span class="token comment">// 排队</span>
<span class="token punctuation">}</span>
<span class="token comment">// 锁三种状态</span>
mutexLocked <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token boolean">iota</span> <span class="token comment">// mutex is locked</span>
mutexWoken
mutexStarving
<span class="token comment">// 正在等待获取锁的goroutine数量</span>
mutexWaiterShift
</code></pre></div><h3 id="加锁"><a href="#加锁" class="header-anchor">#</a> 加锁</h3> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaeqtyr6laj31i80u04qp.jpg" alt="image-20191230144208324"></p> <h3 id="释放锁"><a href="#释放锁" class="header-anchor">#</a> 释放锁</h3> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaeqvjmajvj31xy0huwr4.jpg" alt="image-20191230144341928"></p> <h2 id="内存分配"><a href="#内存分配" class="header-anchor">#</a> 内存分配</h2> <ol><li>每次从操作系统申请一大块儿的内存,由Go来对这块儿内存做分配,减少系统调用</li> <li>内存分配算法采用Google的TCMalloc算法,核心思想就是把内存切分的非常的细小,分为多级管理,以降低锁的粒度。</li> <li>回收对象内存时,并没有将其真正释放掉,只是放回预先分配的大块内存中,以便复用,只有内存闲置过多的时候,才会尝试归还部分内存给操作系统,降低整体开销</li></ol> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaer28xvidj318y0u0b29.jpg" alt="image-20191230145006613"></p> <p>spans和bitmap的大小会随着heap的改变而改变</p> <h3 id="arena"><a href="#arena" class="header-anchor">#</a> arena</h3> <p>arena区域就是我们通常所说的heap.heap中按照管理和使用两个维度:</p> <ol><li>管理分配⻆度,由多个连续的⻚(page)组成的大块内存</li> <li>使用⻆度出发，就是平时咱们所了解的:heap中存在很多&quot;对象“</li></ol> <p>此区域存放了mspan的指针.spans区域用于表示arena区中的某一⻚(page)属于哪个mspan 。</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaer9ebukkj317s0u0dzi.jpg" alt="image-20191230145700859"></p> <p>mspan 可以说是go内存管理的最基本单元，但是内存的使用最终还是要落脚 到“对象”上。 mspan 和对象是什么关系呢? 其实“对象”肯定也放到 page 中，毕竟 page 是内存存储的基本单元。</p> <p>对象分配的时候，根据对象的大小选择大小相近的 span ，这样，碎片问题 就解决了。</p> <h3 id="内存碎片"><a href="#内存碎片" class="header-anchor">#</a> 内存碎片</h3> <p>按需分配。go将内存块分为大小不同的67种，然后再把 这67种大内存块，逐个分为小块(可以近似理解为大小不同的相当于 page )称 之为 span (连续的 page )，在go语言中就是上文提及的 mspan 。</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerbqm9vqj31xe0qudva.jpg" alt="image-20191230145916347"></p> <p>代码中一共有66种，还有一种特殊的span: 即对于大 于32k的对象出现时，会直接从heap分配一个特殊的span，这个特殊的span 的类型(class)是0, 只包含了一个大对象, span的大小由对象的大小决定</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerdwoiuoj31vw0u0gse.jpg" alt="image-20191230150122581"></p> <h2 id="bitmap"><a href="#bitmap" class="header-anchor">#</a> bitmap</h2> <p>bitmap 主要的作用还是服务于GC</p> <p>bitmap 有好几种:Stack, data, and bss bitmaps，再就是这次要说的 heap bitmaps 。 在此bitmap的做作用是标记标记 arena (即heap)中的对象。一是 的标记对应地址中是否存在对象，另外是标记此对象是否被gc标记过。一个 功能一个bit位，所以， heap bitmaps 用两个bit位。 bitmap区域中的一个 byte对应arena区域的四个指针大小的内存的结构如下</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerigofayj312j0u0gwv.jpg" alt="image-20191230150544873"></p> <p>arena 中包含基本的管理单元和程序运行时候生成的对象或实体，这两部分 分别被 spans 和 bitmap 这两块非heap区域的内存所对应着</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerh5manjj315s0u0gue.jpg" alt="image-20191230150429401"></p> <p>spans和bitmap都会根据arena的动态变化而动态调整大小。</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerjf6z1xj31u50u0dp5.jpg" alt="image-20191230150640517"></p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerjvhctoj31820u016r.jpg" alt="image-20191230150705463"></p> <p>mspan 是双向链 表</p> <p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaerl4vt9dj30nk12udmt.jpg" alt="image-20191230150819286"></p> <p>mspan是go内存管理的基本单元,每一个g都会绑定一个mcache,各个g申请内存不存在锁竞争.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">1/1/2020, 4:55:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/goistio.book/istio/内存分配2.html" class="prev">内存分配2</a></span> <span class="next"><a href="/goistio.book/istio/学习笔记.html">istio</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/goistio.book/assets/js/app.c80f4f4d.js" defer></script><script src="/goistio.book/assets/js/2.00693aab.js" defer></script><script src="/goistio.book/assets/js/10.d65de9ee.js" defer></script>
  </body>
</html>
